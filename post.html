<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帖子详情 - 我的独立论坛</title>
    <!-- 引入Bootstrap样式+图标 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { min-height: 100vh; display: flex; flex-direction: column; background-color: #f8f9fa; }
        .main-content { flex: 1; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card { border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .badge-top { background-color: #dc3545; }
        .badge-good { background-color: #ffc107; color: #000; }
        .comment-card { transition: all 0.2s; }
        .comment-card:hover { transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        .loading { text-align: center; padding: 40px 0; color: #6c757d; }
        .post-content { line-height: 1.8; font-size: 15px; }
        .post-content img { max-width: 100%; height: auto; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-chat-dots-fill me-2"></i>我的独立论坛
            </a>
            <div class="d-flex align-items-center">
                <a href="index.html" class="btn btn-sm btn-outline-light me-2">
                    <i class="bi bi-arrow-left me-1"></i> 返回论坛
                </a>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <main class="main-content container py-4">
        <!-- 帖子详情 -->
        <div class="card mb-4" id="post-card">
            <div class="loading p-5"><i class="bi bi-hourglass-split me-2"></i>加载帖子详情中...</div>
        </div>

        <!-- 评论区 -->
        <div class="card" id="comment-card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="mb-0 d-flex align-items-center">
                    <i class="bi bi-chat-fill me-2"></i>评论区
                    <span class="badge bg-secondary ms-2" id="comment-count">0</span>
                </h6>
                <!-- 管理员操作按钮 -->
                <div id="admin-actions" class="d-none">
                    <button class="btn btn-sm btn-danger me-2" onclick="deletePost()"><i class="bi bi-trash me-1"></i>删除帖子</button>
                </div>
            </div>
            <div class="card-body">
                <!-- 评论输入框（仅登录可见） -->
                <div class="mb-4 d-none" id="comment-input">
                    <div id="comment-editor"></div>
                    <button class="btn btn-sm btn-primary mt-2" onclick="publishComment()"><i class="bi bi-send me-1"></i>发表评论</button>
                </div>
                <!-- 未登录提示 -->
                <div class="alert alert-info d-none" id="not-login-tip">
                    请<a href="index.html" class="text-primary">登录</a>后发表评论
                </div>

                <!-- 评论列表 -->
                <div id="comment-list">
                    <div class="loading"><i class="bi bi-hourglass-split me-2"></i>加载评论中...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-3 mt-5">
        <div class="container text-center text-sm">
            <p class="mb-0">© 2026 我的独立论坛 | 基于Supabase + GitHub Pages搭建 | 完全免费 · 独立无依赖</p>
        </div>
    </footer>

    <!-- 引入核心JS文件 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

    <script>
        // ========== 替换为你自己的Supabase信息 ==========
        const SUPABASE_URL = "https://qnensenwgnopttgaepux.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_UB0PqlIa7ylybuvUqoWa1A_73oOWegR";
        // ===============================================

        // 初始化Supabase客户端
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // 全局变量
        const postId = new URLSearchParams(window.location.search).get('id'); // 获取帖子ID
        let currentUser = null;
        let isAdmin = false;
        let currentPost = null; // 当前帖子信息

        // 页面加载初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // 验证帖子ID
            if (!postId || isNaN(postId)) {
                document.getElementById('post-card').innerHTML = '<div class="alert alert-danger text-center p-5">无效的帖子ID</div>';
                document.getElementById('comment-list').innerHTML = '';
                return;
            }

            // 获取当前登录用户
            const { data: { user } } = await supabase.auth.getUser();
            currentUser = user;

            // 检查管理员身份
            if (currentUser) {
                await checkAdminRole();
                // 初始化评论富文本编辑器
                initTinyMCE('comment-editor', 'comment');
                document.getElementById('comment-input').classList.remove('d-none');
            } else {
                document.getElementById('not-login-tip').classList.remove('d-none');
            }

            // 并行加载帖子和评论
            await Promise.all([loadPostDetail(), loadComments()]);
        });

        // 加载帖子详情
        async function loadPostDetail() {
            const { data, error } = await supabase
                .from('posts')
                .select(`
                    id, title, content, is_top, is_good, created_at,
                    profiles(id, username, avatar_url),
                    categories(name)
                `)
                .eq('id', postId)
                .single();

            if (error) {
                document.getElementById('post-card').innerHTML = '<div class="alert alert-danger text-center p-5">帖子不存在或已被删除</div>';
                console.error('加载帖子失败：', error);
                return;
            }

            currentPost = data;
            // 置顶/加精标签
            const tags = [];
            if (data.is_top) tags.push('<span class="badge badge-top me-2">置顶</span>');
            if (data.is_good) tags.push('<span class="badge badge-good me-2">加精</span>');
            // 头像处理
            const avatar = data.profiles.avatar_url || 'https://picsum.photos/200/200';

            // 渲染帖子详情
            const postHtml = `
                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <img src="${avatar}" alt="${data.profiles.username}" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
                        <div>
                            <div class="fw-medium">${data.profiles.username}</div>
                            <div class="text-muted small">${data.categories?.name || '未分类'} · ${formatTime(data.created_at)}</div>
                        </div>
                    </div>
                    ${tags.join('')}
                </div>
                <div class="card-body p-4">
                    <h2 class="card-title h4 mb-4">${data.title}</h2>
                    <div class="post-content">${data.content}</div>
                </div>
            `;
            document.getElementById('post-card').innerHTML = postHtml;

            // 管理员显示操作按钮（置顶/加精）
            if (isAdmin) {
                const adminActions = document.getElementById('admin-actions');
                adminActions.classList.remove('d-none');
                // 插入置顶/加精按钮
                const topGoodBtn = `
                    <button class="btn btn-sm ${data.is_top ? 'btn-danger' : 'btn-outline-danger'} me-2" onclick="togglePostAttr('is_top')">
                        <i class="bi bi-pin-fill me-1"></i>${data.is_top ? '取消置顶' : '置顶'}
                    </button>
                    <button class="btn btn-sm ${data.is_good ? 'btn-warning' : 'btn-outline-warning'} me-2" onclick="togglePostAttr('is_good')">
                        <i class="bi bi-star-fill me-1"></i>${data.is_good ? '取消加精' : '加精'}
                    </button>
                `;
                adminActions.insertAdjacentHTML('afterbegin', topGoodBtn);
            }
        }

        // 加载评论列表
        async function loadComments() {
            const { data, error, count } = await supabase
                .from('comments')
                .select(`
                    id, content, created_at,
                    profiles(id, username, avatar_url)
                `)
                .eq('post_id', postId)
                .order('created_at', { ascending: true })
                .count('exact');

            document.getElementById('comment-count').innerText = count || 0;

            if (error) {
                document.getElementById('comment-list').innerHTML = '<div class="alert alert-danger text-center p-3">评论加载失败</div>';
                console.error('加载评论失败：', error);
                return;
            }

            if (!data || data.length === 0) {
                document.getElementById('comment-list').innerHTML = '<div class="alert alert-light text-center p-3">暂无评论，快来抢沙发吧！</div>';
                return;
            }

            // 渲染评论列表
            let commentHtml = '';
            data.forEach(comment => {
                const avatar = comment.profiles.avatar_url || 'https://picsum.photos/200/200';
                // 简化评论内容（过长截取）
                const contentText = comment.content.replace(/<[^>]+>/g, '');
                const content = contentText.length > 200 ? contentText.substring(0, 200) + '...' : comment.content;

                commentHtml += `
                    <div class="comment-card card mb-3">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="d-flex align-items-center">
                                    <img src="${avatar}" alt="${comment.profiles.username}" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
                                    <span class="fw-medium">${comment.profiles.username}</span>
                                </div>
                                <span class="text-muted small">${formatTime(comment.created_at)}</span>
                            </div>
                            <div class="comment-content">${content}</div>
                            <!-- 管理员删除按钮 -->
                            ${isAdmin ? `<button class="btn btn-sm btn-danger mt-2" onclick="deleteComment(${comment.id})"><i class="bi bi-trash me-1"></i>删除</button>` : ''}
                        </div>
                    </div>
                `;
            });
            document.getElementById('comment-list').innerHTML = commentHtml;
        }

        // 发布评论
        async function publishComment() {
            const content = tinymce.get('comment-editor').getContent().trim();

            if (!content) {
                alert('请输入评论内容！');
                return;
            }

            // 提交到数据库
            const { error } = await supabase
                .from('comments')
                .insert([{
                    content,
                    post_id: postId,
                    user_id: currentUser.id
                }]);

            if (error) {
                alert('评论发布失败：' + error.message);
                console.error(error);
                return;
            }

            // 发布成功：清空编辑器、重新加载评论
            tinymce.get('comment-editor').setContent('');
            loadComments();
        }

        // 切换帖子属性（置顶/加精）
        async function togglePostAttr(attr) {
            const newVal = !currentPost[attr];
            const { error } = await supabase
                .from('posts')
                .update({ [attr]: newVal })
                .eq('id', postId);

            if (error) {
                alert('操作失败：' + error.message);
                console.error(error);
                return;
            }

            // 更新成功：重新加载帖子
            currentPost[attr] = newVal;
            loadPostDetail();
        }

        // 删除帖子
        async function deletePost() {
            if (!confirm('确定删除该帖子吗？删除后所有评论将一并删除，且无法恢复！')) {
                return;
            }

            const { error } = await supabase
                .from('posts')
                .delete()
                .eq('id', postId);

            if (error) {
                alert('删除失败：' + error.message);
                console.error(error);
                return;
            }

            // 跳回论坛首页
            window.location.href = 'index.html';
        }

        // 删除评论
        async function deleteComment(commentId) {
            if (!confirm('确定删除该评论吗？')) {
                return;
            }

            const { error } = await supabase
                .from('comments')
                .delete()
                .eq('id', commentId);

            if (error) {
                alert('删除失败：' + error.message);
                console.error(error);
                return;
            }

            // 重新加载评论
            loadComments();
        }

        // 初始化富文本编辑器
        function initTinyMCE(editorId, type) {
            tinymce.init({
                selector: `#${editorId}`,
                height: type === 'post' ? 300 : 150,
                menubar: false,
                plugins: 'advlist autolink lists link image charmap preview removeformat help',
                toolbar: 'undo redo | bold italic | alignleft aligncenter | bullist numlist | image | removeformat | help',
                images_upload_handler: async (blobInfo, progress) => {
                    return new Promise(async (resolve, reject) => {
                        const fileName = `${currentUser.id}/${Date.now()}-${blobInfo.filename()}`;
                        const blob = await blobInfo.blob();

                        const { data, error } = await supabase
                            .storage
                            .from('forum-assets')
                            .upload(fileName, blob, {
                                cacheControl: '3600',
                                upsert: false,
                                contentType: blob.type
                            });

                        if (error) {
                            reject('图片上传失败：' + error.message);
                            return;
                        }

                        const { data: { publicUrl } } = supabase
                            .storage
                            .from('forum-assets')
                            .getPublicUrl(data.path);

                        resolve(publicUrl);
                    });
                },
                branding: false,
                resize: false,
                placeholder: '请输入评论内容，支持图片、文字排版...'
            });
        }

        // 检查管理员身份
        async function checkAdminRole() {
            const { data, error } = await supabase
                .from('admins')
                .select('*')
                .eq('user_id', currentUser.id)
                .single();

            isAdmin = !error && data;
        }

        // 格式化时间
        function formatTime(timeStr) {
            const date = new Date(timeStr);
            return date.getFullYear() + '-' +
                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                String(date.getDate()).padStart(2, '0') + ' ' +
                String(date.getHours()).padStart(2, '0') + ':' +
                String(date.getMinutes()).padStart(2, '0');
        }
    </script>
</body>
</html>
