<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人中心 - 我的独立论坛</title>
    <!-- 引入依赖样式 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { min-height: 100vh; display: flex; flex-direction: column; background-color: #f8f9fa; }
        .main-content { flex: 1; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card { border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .profile-header { background: linear-gradient(135deg, #0d6efd 0%, #3b82f6 100%); color: white; padding: 30px 20px; border-radius: 8px; }
        .avatar-lg { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid white; }
        .nav-pills .nav-link.active { background-color: #0d6efd; }
        .post-item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .post-item:last-child { border-bottom: none; }
        .post-meta { color: #6c757d; font-size: 0.9rem; }
        .upload-avatar-area { border: 2px dashed #ced4da; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .upload-avatar-area:hover { border-color: #0d6efd; background-color: #f0f7ff; }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-chat-dots-fill me-2"></i>我的独立论坛
            </a>
            <div class="d-flex align-items-center ms-auto">
                <a href="index.html" class="btn btn-sm btn-outline-light me-2">
                    <i class="bi bi-house me-1"></i> 回到首页
                </a>
                <button class="btn btn-sm btn-light" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-1"></i> 退出登录
                </button>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <main class="main-content container py-4">
        <div class="row">
            <!-- 左侧个人信息 -->
            <div class="col-md-4">
                <!-- 个人信息头部 -->
                <div class="card">
                    <div class="profile-header text-center">
                        <img src="" alt="用户头像" class="avatar-lg mb-3" id="userAvatarLg">
                        <h4 id="userNameLg" class="mb-1">加载中...</h4>
                        <p class="text-white-50 mb-0" id="joinTime">注册时间：加载中...</p>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-around text-center mb-4">
                            <div>
                                <h5 class="mb-0" id="postCount">0</h5>
                                <small class="text-muted">发布帖子</small>
                            </div>
                            <div>
                                <h5 class="mb-0" id="commentCount">0</h5>
                                <small class="text-muted">发布评论</small>
                            </div>
                        </div>

                        <!-- 头像修改 -->
                        <div class="mb-4">
                            <h6 class="mb-2">修改头像</h6>
                            <div class="upload-avatar-area" onclick="document.getElementById('avatarInput').click()">
                                <i class="bi bi-cloud-upload text-secondary me-2"></i> 点击上传新头像
                                <input type="file" id="avatarInput" class="d-none" accept="image/jpeg,image/png,image/gif">
                            </div>
                        </div>

                        <!-- 用户名修改 -->
                        <div>
                            <h6 class="mb-2">修改用户名</h6>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="newUsername" placeholder="输入新用户名">
                                <button class="btn btn-outline-primary" onclick="updateUsername()">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧内容区 -->
            <div class="col-md-8">
                <!-- 选项卡 -->
                <ul class="nav nav-pills mb-3" id="profileTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="my-posts-tab" data-bs-toggle="pill" data-bs-target="#my-posts" type="button" role="tab">我的帖子</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="my-comments-tab" data-bs-toggle="pill" data-bs-target="#my-comments" type="button" role="tab">我的评论</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="settings-tab" data-bs-toggle="pill" data-bs-target="#settings" type="button" role="tab">账号设置</button>
                    </li>
                </ul>

                <!-- 选项卡内容 -->
                <div class="tab-content" id="profileTabContent">
                    <!-- 我的帖子 -->
                    <div class="tab-pane fade show active" id="my-posts" role="tabpanel">
                        <div class="card">
                            <div class="card-body" id="myPostsList">
                                <div class="text-center py-5 text-secondary">
                                    <i class="bi bi-hourglass-half me-2"></i>加载我的帖子中...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 我的评论 -->
                    <div class="tab-pane fade" id="my-comments" role="tabpanel">
                        <div class="card">
                            <div class="card-body" id="myCommentsList">
                                <div class="text-center py-5 text-secondary">
                                    <i class="bi bi-hourglass-half me-2"></i>加载我的评论中...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 账号设置 -->
                    <div class="tab-pane fade" id="settings" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">账号安全设置</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="oldPassword" class="form-label">当前密码</label>
                                    <input type="password" class="form-control form-control-sm" id="oldPassword" placeholder="输入当前密码">
                                </div>
                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">新密码</label>
                                    <input type="password" class="form-control form-control-sm" id="newPassword" placeholder="输入新密码（至少8位）">
                                </div>
                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label">确认新密码</label>
                                    <input type="password" class="form-control form-control-sm" id="confirmPassword" placeholder="再次输入新密码">
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="updatePassword()">修改密码</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-light py-3 mt-4">
        <div class="container text-center">
            <p class="mb-0">© 2025 我的独立论坛 - 基于 Supabase + Bootstrap 构建</p>
        </div>
    </footer>

    <!-- 引入依赖脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ========== 核心配置（必须替换为你的Supabase信息） ==========
        const supabaseUrl = '你的Supabase项目URL'; // 例如：https://xxxx.supabase.co
        const supabaseKey = '你的Supabase anon key'; // 公钥，在API设置里找
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // 全局变量
        let currentUser = null; // 当前登录用户信息
        let currentProfile = null; // 当前用户资料

        // 页面加载初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. 验证登录状态（未登录跳转登录页）
            const loginStatus = await checkUserLogin();
            if (!loginStatus) return;

            // 2. 加载用户基本信息
            await loadUserProfile();

            // 3. 加载我的帖子
            await loadMyPosts();

            // 4. 加载我的评论
            await loadMyComments();

            // 5. 初始化头像上传
            initAvatarUpload();
        });

        // 1. 验证用户登录状态
        async function checkUserLogin() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                if (error) throw error;
                
                // 未登录：跳转登录页
                if (!user) {
                    alert('请先登录后再访问个人中心');
                    window.location.href = 'login.html';
                    return false;
                }

                currentUser = user;
                return true;
            } catch (err) {
                console.error('登录验证失败:', err);
                alert('登录状态验证失败，请刷新页面重试');
                return false;
            }
        }

        // 2. 加载用户基本信息
        async function loadUserProfile() {
            try {
                // 查询用户资料
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error) throw error;
                currentProfile = profile;

                // 填充页面信息
                document.getElementById('userAvatarLg').src = profile.avatar_url || 'https://via.placeholder.com/100';
                document.getElementById('userNameLg').textContent = profile.username || '未设置用户名';
                document.getElementById('newUsername').value = profile.username || '';
                
                // 格式化注册时间
                if (profile.created_at) {
                    const joinDate = new Date(profile.created_at);
                    document.getElementById('joinTime').textContent = `注册时间：${joinDate.toLocaleDateString('zh-CN')}`;
                }

                // 统计帖子数和评论数
                const [postCountRes, commentCountRes] = await Promise.all([
                    supabase.from('posts').select('id', { count: 'exact' }).eq('user_id', currentUser.id),
                    supabase.from('comments').select('id', { count: 'exact' }).eq('user_id', currentUser.id)
                ]);

                document.getElementById('postCount').textContent = postCountRes.count || 0;
                document.getElementById('commentCount').textContent = commentCountRes.count || 0;

            } catch (err) {
                console.error('加载用户信息失败:', err);
                alert('加载个人信息失败，请刷新页面重试');
            }
        }

        // 3. 加载我的帖子
        async function loadMyPosts() {
            try {
                const { data: posts, error } = await supabase
                    .from('posts')
                    .select(`
                        *,
                        categories:category_id (name)
                    `)
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const myPostsList = document.getElementById('myPostsList');
                if (posts.length === 0) {
                    myPostsList.innerHTML = '<div class="text-center py-5 text-secondary">你还没有发布任何帖子</div>';
                    return;
                }

                // 渲染我的帖子列表
                myPostsList.innerHTML = posts.map(post => `
                    <div class="post-item">
                        <h6 class="mb-1 fw-bold">
                            <a href="post_detail.html?id=${post.id}" class="text-dark text-decoration-none">${post.title}</a>
                        </h6>
                        <div class="post-meta d-flex justify-content-between align-items-center">
                            <span>
                                <span class="badge bg-secondary">${post.categories?.name || '未分类'}</span> · 
                                <span>${formatTime(post.created_at)}</span>
                            </span>
                            <span class="d-flex align-items-center">
                                <i class="bi bi-comment-dots me-1"></i> ${post.comment_count || 0}
                                <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteMyPost(${post.id})">
                                    <i class="bi bi-trash"></i> 删除
                                </button>
                            </span>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                console.error('加载我的帖子失败:', err);
                document.getElementById('myPostsList').innerHTML = '<div class="text-center py-5 text-danger">帖子加载失败</div>';
            }
        }

        // 4. 加载我的评论
        async function loadMyComments() {
            try {
                const { data: comments, error } = await supabase
                    .from('comments')
                    .select(`
                        *,
                        posts:post_id (id, title)
                    `)
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const myCommentsList = document.getElementById('myCommentsList');
                if (comments.length === 0) {
                    myCommentsList.innerHTML = '<div class="text-center py-5 text-secondary">你还没有发布任何评论</div>';
                    return;
                }

                // 渲染我的评论列表
                myCommentsList.innerHTML = comments.map(comment => `
                    <div class="post-item">
                        <div class="mb-1">
                            <a href="post_detail.html?id=${comment.posts?.id}" class="text-dark text-decoration-none">
                                <small class="fw-bold">${comment.posts?.title || '已删除帖子'}</small>
                            </a>
                        </div>
                        <p class="mb-2 text-muted">${comment.content}</p>
                        <div class="post-meta d-flex justify-content-between">
                            <span>${formatTime(comment.created_at)}</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteMyComment(${comment.id})">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                console.error('加载我的评论失败:', err);
                document.getElementById('myCommentsList').innerHTML = '<div class="text-center py-5 text-danger">评论加载失败</div>';
            }
        }

        // 5. 初始化头像上传
        function initAvatarUpload() {
            const avatarInput = document.getElementById('avatarInput');
            avatarInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // 验证文件类型和大小
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
                if (!allowedTypes.includes(file.type)) {
                    alert('仅支持JPG/PNG/GIF格式的图片');
                    return;
                }
                if (file.size > 2 * 1024 * 1024) {
                    alert('头像大小不能超过2MB');
                    return;
                }

                try {
                    // 生成唯一文件名
                    const fileName = `avatars/${currentUser.id}_${Date.now()}.${file.name.split('.').pop()}`;
                    
                    // 上传到Supabase Storage
                    const { data: uploadData, error: uploadErr } = await supabase
                        .storage
                        .from('forum-images') // 需和post.html的存储桶名称一致
                        .upload(fileName, file, {
                            cacheControl: '3600',
                            upsert: true
                        });

                    if (uploadErr) throw uploadErr;

                    // 获取公共URL
                    const { data: urlData } = supabase
                        .storage
                        .from('forum-images')
                        .getPublicUrl(uploadData.path);

                    // 更新用户资料中的头像URL
                    const { error: updateErr } = await supabase
                        .from('profiles')
                        .update({ avatar_url: urlData.publicUrl })
                        .eq('id', currentUser.id);

                    if (updateErr) throw updateErr;

                    // 更新页面显示
                    document.getElementById('userAvatarLg').src = urlData.publicUrl;
                    alert('头像修改成功！');

                } catch (err) {
                    console.error('上传头像失败:', err);
                    alert(`头像上传失败：${err.message}`);
                }

                // 清空文件输入框
                avatarInput.value = '';
            });
        }

        // 6. 修改用户名
        async function updateUsername() {
            const newUsername = document.getElementById('newUsername').value.trim();
            if (!newUsername) {
                alert('请输入新用户名');
                return;
            }
            if (newUsername === currentProfile.username) {
                alert('新用户名和当前用户名一致');
                return;
            }

            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ username: newUsername })
                    .eq('id', currentUser.id);

                if (error) throw error;

                // 更新页面显示
                document.getElementById('userNameLg').textContent = newUsername;
                currentProfile.username = newUsername;
                alert('用户名修改成功！');

            } catch (err) {
                console.error('修改用户名失败:', err);
                alert(`修改失败：${err.message}`);
            }
        }

        // 7. 修改密码
        async function updatePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // 验证表单
            if (!oldPassword || !newPassword || !confirmPassword) {
                alert('请填写所有密码字段');
                return;
            }
            if (newPassword !== confirmPassword) {
                alert('两次输入的新密码不一致');
                return;
            }
            if (newPassword.length < 8) {
                alert('新密码长度不能少于8位');
                return;
            }

            try {
                // 第一步：用旧密码重新验证身份
                const { error: authErr } = await supabase.auth.signInWithPassword({
                    email: currentUser.email,
                    password: oldPassword
                });

                if (authErr) throw new Error('当前密码输入错误');

                // 第二步：更新密码
                const { error: updateErr } = await supabase.auth.updateUser({
                    password: newPassword
                });

                if (updateErr) throw updateErr;

                // 重置表单并提示
                document.getElementById('oldPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                alert('密码修改成功！请重新登录');
                
                // 退出登录
                await logout();

            } catch (err) {
                console.error('修改密码失败:', err);
                alert(`修改失败：${err.message}`);
            }
        }

        // 8. 删除我的帖子
        async function deleteMyPost(postId) {
            if (!confirm('确定要删除这篇帖子吗？删除后无法恢复')) {
                return;
            }

            try {
                // 先删除帖子关联的评论（可选）
                await supabase.from('comments').delete().eq('post_id', postId);

                // 删除帖子
                const { error } = await supabase
                    .from('posts')
                    .delete()
                    .eq('id', postId)
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                // 重新加载帖子列表
                await loadMyPosts();
                // 更新帖子数统计
                const { count } = await supabase.from('posts').select('id', { count: 'exact' }).eq('user_id', currentUser.id);
                document.getElementById('postCount').textContent = count || 0;

                alert('帖子删除成功！');

            } catch (err) {
                console.error('删除帖子失败:', err);
                alert(`删除失败：${err.message}`);
            }
        }

        // 9. 删除我的评论
        async function deleteMyComment(commentId) {
            if (!confirm('确定要删除这条评论吗？删除后无法恢复')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('comments')
                    .delete()
                    .eq('id', commentId)
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                // 重新加载评论列表
                await loadMyComments();
                // 更新评论数统计
                const { count } = await supabase.from('comments').select('id', { count: 'exact' }).eq('user_id', currentUser.id);
                document.getElementById('commentCount').textContent = count || 0;

                alert('评论删除成功！');

            } catch (err) {
                console.error('删除评论失败:', err);
                alert(`删除失败：${err.message}`);
            }
        }

        // 10. 退出登录
        async function logout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                alert('退出失败：' + error.message);
                return;
            }
            window.location.href = 'index.html';
        }

        // 11. 时间格式化工具函数
        function formatTime(isoTime) {
            const date = new Date(isoTime);
            const now = new Date();
            const diff = now - date;

            if (diff < 60 * 1000) return '刚刚';
            if (diff < 60 * 60 * 1000) return `${Math.floor(diff / (60 * 1000))}分钟前`;
            if (diff < 24 * 60 * 60 * 1000) return `${Math.floor(diff / (60 * 60 * 1000))}小时前`;
            return date.toLocaleDateString('zh-CN');
        }
    </script>
</body>
</html>
