<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>论坛管理后台 - 我的独立论坛</title>
    <!-- 引入Bootstrap样式+图标 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { min-height: 100vh; display: flex; flex-direction: column; background-color: #f8f9fa; }
        .main-content { flex: 1; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card { border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .nav-pills .nav-link.active { background-color: #0d6efd; }
        .loading { text-align: center; padding: 40px 0; color: #6c757d; }
        .table-sm th, .table-sm td { vertical-align: middle; }
        .badge-top { background-color: #dc3545; }
        .badge-good { background-color: #ffc107; color: #000; }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-shield-fill me-2"></i>论坛管理后台
            </a>
            <div class="d-flex align-items-center">
                <a href="index.html" class="btn btn-sm btn-outline-light me-2">
                    <i class="bi bi-house me-1"></i> 回到论坛
                </a>
                <button class="btn btn-sm btn-light" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-1"></i> 退出登录
                </button>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <main class="main-content container py-4">
        <div class="row">
            <!-- 左侧导航 -->
            <div class="col-md-3 mb-4">
                <div class="card">
                    <div class="card-body p-0">
                        <ul class="nav nav-pills flex-column p-3">
                            <li class="nav-item mb-2">
                                <a class="nav-link active" href="#post-manage" data-bs-toggle="tab"><i class="bi bi-list-ul me-2"></i>帖子管理</a>
                            </li>
                            <li class="nav-item mb-2">
                                <a class="nav-link" href="#comment-manage" data-bs-toggle="tab"><i class="bi bi-chat-fill me-2"></i>评论管理</a>
                            </li>
                            <li class="nav-item mb-2">
                                <a class="nav-link" href="#category-manage" data-bs-toggle="tab"><i class="bi bi-grid-1x2-fill me-2"></i>板块管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#user-manage" data-bs-toggle="tab"><i class="bi bi-people-fill me-2"></i>用户管理</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 右侧内容 -->
            <div class="col-md-9">
                <div class="tab-content" id="adminTabContent">
                    <!-- 1. 帖子管理 -->
                    <div class="tab-pane fade show active" id="post-manage" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-list-ul me-2"></i>帖子管理</h6>
                                <div class="d-flex gap-2">
                                    <input type="text" class="form-control form-control-sm w-50" id="post-search" placeholder="搜索帖子标题" oninput="searchPosts()">
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="5%">ID</th>
                                                <th width="30%">标题</th>
                                                <th width="15%">作者</th>
                                                <th width="15%">板块</th>
                                                <th width="10%">状态</th>
                                                <th width="15%">发布时间</th>
                                                <th width="10%">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="post-table-body">
                                            <tr><td colspan="7" class="text-center py-4 loading"><i class="bi bi-hourglass-split me-2"></i>加载帖子中...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. 评论管理 -->
                    <div class="tab-pane fade" id="comment-manage" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-chat-fill me-2"></i>评论管理</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="5%">ID</th>
                                                <th width="35%">评论内容</th>
                                                <th width="15%">作者</th>
                                                <th width="20%">所属帖子</th>
                                                <th width="15%">发布时间</th>
                                                <th width="10%">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="comment-table-body">
                                            <tr><td colspan="6" class="text-center py-4 loading"><i class="bi bi-hourglass-split me-2"></i>加载评论中...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. 板块管理 -->
                    <div class="tab-pane fade" id="category-manage" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-grid-1x2-fill me-2"></i>板块管理</h6>
                                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#categoryModal" onclick="resetCategoryForm()"><i class="bi bi-plus me-1"></i>新增板块</button>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="5%">ID</th>
                                                <th width="25%">板块名称</th>
                                                <th width="35%">描述</th>
                                                <th width="10%">排序</th>
                                                <th width="25%">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="category-table-body">
                                            <tr><td colspan="5" class="text-center py-4 loading"><i class="bi bi-hourglass-split me-2"></i>加载板块中...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. 用户管理 -->
                    <div class="tab-pane fade" id="user-manage" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-people-fill me-2"></i>用户管理</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="10%">ID</th>
                                                <th width="15%">头像</th>
                                                <th width="20%">昵称</th>
                                                <th width="30%">邮箱</th>
                                                <th width="15%">注册时间</th>
                                                <th width="10%">状态</th>
                                            </tr>
                                        </thead>
                                        <tbody id="user-table-body">
                                            <tr><td colspan="6" class="text-center py-4 loading"><i class="bi bi-hourglass-split me-2"></i>加载用户中...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 板块新增/编辑弹窗 -->
    <div class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalTitle">新增板块</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="category-id">
                    <div class="mb-3">
                        <label class="form-label small">板块名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-sm" id="category-name" placeholder="请输入板块名称（如：技术分享）" maxlength="20">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small">板块描述</label>
                        <textarea class="form-control form-control-sm" id="category-desc" rows="2" placeholder="请输入板块描述（选填）" maxlength="100"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small">排序序号 <span class="text-danger">*</span></label>
                        <input type="number" class="form-control form-control-sm" id="category-sort" placeholder="数字越小，排序越靠前" value="0" min="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-sm btn-primary" onclick="saveCategory()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入核心JS文件 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>

    <script>
        // ========== 替换为你自己的Supabase信息 ==========
        const SUPABASE_URL = "https://qnensenwgnopttgaepux.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_UB0PqlIa7ylybuvUqoWa1A_73oOWegR";
        // ===============================================

        // 初始化Supabase客户端
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // 全局变量
        let allPosts = []; // 所有帖子
        let allCategories = []; // 所有板块
        let allUsers = []; // 所有用户

        // 页面加载初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // 验证管理员身份（非管理员跳回首页）
            await checkAdminAuth();
            // 并行加载所有数据
            await Promise.all([
                loadPosts(),
                loadComments(),
                loadCategories(),
                loadUsers()
            ]);
        });

        // 验证管理员身份
        async function checkAdminAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                alert('请先登录！');
                window.location.href = 'index.html';
                return;
            }

            const { data, error } = await supabase
                .from('admins')
                .select('*')
                .eq('user_id', user.id)
                .single();

            if (error || !data) {
                alert('你没有管理员权限，禁止访问！');
                window.location.href = 'index.html';
            }
        }

        // 加载帖子
        async function loadPosts() {
            const { data, error } = await supabase
                .from('posts')
                .select(`
                    id, title, is_top, is_good, created_at,
                    profiles(username),
                    categories(name)
                `)
                .order('is_top', { ascending: false })
                .order('created_at', { ascending: false });

            if (error) {
                document.getElementById('post-table-body').innerHTML = '<tr><td colspan="7" class="text-center text-danger py-3">帖子加载失败</td></tr>';
                console.error(error);
                return;
            }

            allPosts = data || [];
            renderPostsTable(allPosts);
        }

        // 渲染帖子表格
        function renderPostsTable(posts) {
            if (posts.length === 0) {
                document.getElementById('post-table-body').innerHTML = '<tr><td colspan="7" class="text-center py-3">暂无帖子</td></tr>';
                return;
            }

            let html = '';
            posts.forEach(post => {
                const status = [];
                if (post.is_top) status.push('<span class="badge badge-top badge-sm">置顶</span>');
                if (post.is_good) status.push('<span class="badge badge-good badge-sm">加精</span>');
                html += `
                    <tr>
                        <td>${post.id}</td>
                        <td><a href="post.html?id=${post.id}" target="_blank" class="text-primary">${post.title}</a></td>
                        <td>${post.profiles.username}</td>
                        <td>${post.categories?.name || '未分类'}</td>
                        <td>${status.join(' ') || '普通'}</td>
                        <td>${formatTime(post.created_at)}</td>
                        <td>
                            <a href="post.html?id=${post.id}" target="_blank" class="btn btn-sm btn-outline-primary me-1"><i class="bi bi-eye"></i></a>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePost(${post.id})"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            document.getElementById('post-table-body').innerHTML = html;
        }

        // 搜索帖子
        function searchPosts() {
            const keyword = document.getElementById('post-search').value.trim().toLowerCase();
            if (!keyword) {
                renderPostsTable(allPosts);
                return;
            }
            const filtered = allPosts.filter(post => post.title.toLowerCase().includes(keyword));
            renderPostsTable(filtered);
        }

        // 加载评论
        async function loadComments() {
            const { data, error } = await supabase
                .from('comments')
                .select(`
                    id, content, created_at,
                    profiles(username),
                    posts(id, title)
                `)
                .order('created_at', { ascending: false });

            if (error) {
                document.getElementById('comment-table-body').innerHTML = '<tr><td colspan="6" class="text-center text-danger py-3">评论加载失败</td></tr>';
                console.error(error);
                return;
            }

            const comments = data || [];
            if (comments.length === 0) {
                document.getElementById('comment-table-body').innerHTML = '<tr><td colspan="6" class="text-center py-3">暂无评论</td></tr>';
                return;
            }

            let html = '';
            comments.forEach(comment => {
                const content = comment.content.replace(/<[^>]+>/g, '').substring(0, 50) + '...';
                html += `
                    <tr>
                        <td>${comment.id}</td>
                        <td>${content}</td>
                        <td>${comment.profiles.username}</td>
                        <td><a href="post.html?id=${comment.posts.id}" target="_blank" class="text-primary">${comment.posts.title}</a></td>
                        <td>${formatTime(comment.created_at)}</td>
                        <td><button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id})"><i class="bi bi-trash"></i></button></td>
                    </tr>
                `;
            });
            document.getElementById('comment-table-body').innerHTML = html;
        }

        // 加载板块
        async function loadCategories() {
            const { data, error } = await supabase
                .from('categories')
                .select('*')
                .order('sort', { ascending: true });

            if (error) {
                document.getElementById('category-table-body').innerHTML = '<tr><td colspan="5" class="text-center text-danger py-3">板块加载失败</td></tr>';
                console.error(error);
                return;
            }

            allCategories = data || [];
            if (allCategories.length === 0) {
                document.getElementById('category-table-body').innerHTML = '<tr><td colspan="5" class="text-center py-3">暂无板块</td></tr>';
                return;
            }

            let html = '';
            allCategories.forEach(cate => {
                html += `
                    <tr>
                        <td>${cate.id}</td>
                        <td>${cate.name}</td>
                        <td>${cate.description || '无'}</td>
                        <td>${cate.sort}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editCategory(${cate.id})"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${cate.id})"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            document.getElementById('category-table-body').innerHTML = html;
        }

        // 加载用户
        async function loadUsers() {
            // 获取认证用户列表
            const { data: authUsers, error: authError } = await supabase.auth.admin.listUsers();
            if (authError) {
                document.getElementById('user-table-body').innerHTML = '<tr><td colspan="6" class="text-center text-danger py-3">用户加载失败</td></tr>';
                console.error(authError);
                return;
            }

            // 获取用户资料
            const userIds = authUsers.users.map(u => u.id);
            const { data: profiles, error: profileError } = await supabase
                .from('profiles')
                .select('id, username, avatar_url')
                .in('id', userIds);

            if (profileError) {
                document.getElementById('user-table-body').innerHTML = '<tr><td colspan="6" class="text-center text-danger py-3">用户资料加载失败</td></tr>';
                console.error(profileError);
                return;
            }

            // 合并用户数据
            const profileMap = {};
            profiles.forEach(p => profileMap[p.id] = p);
            allUsers = authUsers.users.map(u => ({
                id: u.id,
                email: u.email,
                created_at: u.created_at,
                username: profileMap[u.id]?.username || '未知',
                avatar_url: profileMap[u.id]?.avatar_url || 'https://picsum.photos/200/200',
                status: u.email_confirmed_at ? '已验证' : '未验证'
            }));

            if (allUsers.length === 0) {
                document.getElementById('user-table-body').innerHTML = '<tr><td colspan="6" class="text-center py-3">暂无用户</td></tr>';
                return;
            }

            let html = '';
            allUsers.forEach(user => {
                html += `
                    <tr>
                        <td>${user.id.substring(0, 8)}...</td>
                        <td><img src="${user.avatar_url}" alt="${user.username}" class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;"></td>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td>${formatTime(user.created_at)}</td>
                        <td><span class="badge ${user.status === '已验证' ? 'bg-success' : 'bg-warning'} badge-sm">${user.status}</span></td>
                    </tr>
                `;
            });
            document.getElementById('user-table-body').innerHTML = html;
        }

        // 重置板块表单（新增）
        function resetCategoryForm() {
            document.getElementById('categoryModalTitle').innerText = '新增板块';
            document.getElementById('category-id').value = '';
            document.getElementById('category-name').value = '';
            document.getElementById('category-desc').value = '';
            document.getElementById('category-sort').value = 0;
        }

        // 编辑板块
        async function editCategory(cateId) {
            const cate = allCategories.find(c => c.id === cateId);
            if (!cate) return;
            document.getElementById('categoryModalTitle').innerText = '编辑板块';
            document.getElementById('category-id').value = cate.id;
            document.getElementById('category-name').value = cate.name;
            document.getElementById('category-desc').value = cate.description || '';
            document.getElementById('category-sort').value = cate.sort;
            new bootstrap.Modal(document.getElementById('categoryModal')).show();
        }

        // 保存板块（新增/编辑）
        async function saveCategory() {
            const id = document.getElementById('category-id').value;
            const name = document.getElementById('category-name').value.trim();
            const desc = document.getElementById('category-desc').value.trim();
            const sort = parseInt(document.getElementById('category-sort').value) || 0;

            // 验证
            if (!name) {
                alert('请输入板块名称！');
                return;
            }
            if (name.length > 20) {
                alert('板块名称不能超过20字！');
                return;
            }

            let { error } = {};
            if (id) {
                // 编辑板块
                ({ error } = await supabase
                    .from('categories')
                    .update({ name, description: desc, sort })
                    .eq('id', id));
            } else {
                // 新增板块
                ({ error } = await supabase
                    .from('categories')
                    .insert([{ name, description: desc, sort }]));
            }

            if (error) {
                alert('操作失败：' + error.message);
                console.error(error);
                return;
            }

            // 成功：关闭弹窗、重新加载板块
            bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
            loadCategories();
            loadPosts(); // 重新加载帖子（更新板块关联）
            alert(id ? '板块编辑成功！' : '板块新增成功！');
        }

        // 删除帖子
        async function deletePost(postId) {
            if (!confirm('确定删除该帖子吗？删除后所有评论将一并删除，且无法恢复！')) return;
            const { error } = await supabase
                .from('posts')
                .delete()
                .eq('id', postId);
            if (error) {
                alert('删除失败：' + error.message);
                console.error(error);
                return;
            }
            loadPosts();
            loadComments();
        }

        // 删除评论
        async function deleteComment(commentId) {
            if (!confirm('确定删除该评论吗？')) return;
            const { error } = await supabase
                .from('comments')
                .delete()
                .eq('id', commentId);
            if (error) {
                alert('删除失败：' + error.message);
                console.error(error);
                return;
            }
            loadComments();
        }

        // 删除板块
        async function deleteCategory(cateId) {
            if (!confirm('确定删除该板块吗？板块下的帖子将被标记为"未分类"！')) return;
            const { error } = await supabase
                .from('categories')
                .delete()
                .eq('id', cateId);
            if (error) {
                alert('删除失败：' + error.message);
                console.error(error);
                return;
            }
            loadCategories();
            loadPosts();
        }

        // 退出登录
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        // 格式化时间
        function formatTime(timeStr) {
            const date = new Date(timeStr);
            return date.getFullYear() + '-' +
                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                String(date.getDate()).padStart(2, '0') + ' ' +
                String(date.getHours()).padStart(2, '0') + ':' +
                String(date.getMinutes()).padStart(2, '0');
        }
    </script>
</body>
</html>
