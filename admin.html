        <!-- 板块管理 -->
        <div class="tab-pane fade show active" id="categories" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">板块管理</h5>
                    <button class="btn btn-primary btn-sm" onclick="openCategoryModal()">
                        <<i class="bi bi-plus-circle me-1"></</i> 新增板块
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <<th>ID</</th>
                                    <<th>板块名称</</th>
                                    <<th>排序</</th>
                                    <<th>帖子数</</th>
                                    <<th>操作</</th>
                                </tr>
                            </thead>
                            <tbody id="category-table-body" class="loading">
                                <tr><td colspan="5" class="text-center py-3">加载板块中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 帖子管理 -->
        <div class="tab-pane fade" id="posts" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">帖子管理</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <<th>ID</</th>
                                    <<th>标题</</th>
                                    <<th>作者</</th>
                                    <<th>板块</</th>
                                    <<th>发布时间</</th>
                                    <<th>操作</</th>
                                </tr>
                            </thead>
                            <tbody id="post-table-body" class="loading">
                                <tr><td colspan="6" class="text-center py-3">加载帖子中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 用户管理 -->
        <div class="tab-pane fade" id="users" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">用户管理</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <<th>ID</</th>
                                    <<th>用户名</</th>
                                    <<th>注册时间</</th>
                                    <<th>帖子数</</th>
                                    <<th>操作</</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body" class="loading">
                                <tr><td colspan="5" class="text-center py-3">加载用户中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 板块模态框 -->
    <div class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title" id="categoryModalTitle">新增板块</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <input type="hidden" id="categoryId">
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">板块名称</label>
                            <input type="text" class="form-control form-control-sm" id="categoryName" required>
                        </div>
                        <div class="mb-3">
                            <label for="categorySort" class="form-label">排序（数字越小越靠前）</label>
                            <input type="number" class="form-control form-control-sm" id="categorySort" value="0" min="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-sm btn-primary" onclick="saveCategory()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入依赖脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // 初始化Supabase（请替换为你的项目信息）
        const supabaseUrl = '你的Supabase Project URL';
        const supabaseKey = '你的Supabase anon key';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // 全局变量
        let currentCategoryId = null;
        const categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));

        // 页面加载时验证管理员身份并加载数据
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAdmin();
            await loadCategories();
            await loadPosts();
            await loadUsers();
        });

        // 1. 管理员身份验证
        async function checkAdmin() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                alert('请先登录');
                window.location.href = 'login.html';
                return;
            }

            const { data: admin, error } = await supabase
                .from('admins')
                .select('*')
                .eq('user_id', user.id)
                .single();

            if (error || !admin) {
                alert('无管理员权限，即将返回论坛');
                window.location.href = 'index.html';
            }
        }

        // 2. 加载板块列表
        async function loadCategories() {
            const { data, error } = await supabase
                .from('categories')
                .select('*')
                .order('sort', { ascending: true });

            const tableBody = document.getElementById('category-table-body');
            if (error) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger py-3">板块加载失败</td></tr>';
                console.error('加载板块错误:', error);
                return;
            }

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-3">暂无板块</td></tr>';
                return;
            }

            // 渲染板块表格
            tableBody.innerHTML = data.map(category => `
                <tr>
                    <td>${category.id}</td>
                    <td>${category.name}</td>
                    <td>${category.sort}</td>
                    <td>${category.post_count || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editCategory(${category.id}, '${category.name}', ${category.sort})">
                            <<i class="bi bi-pencil"></</i> 编辑
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${category.id})">
                            <<i class="bi bi-trash"></</i> 删除
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 3. 加载帖子列表
        async function loadPosts() {
            const { data, error } = await supabase
                .from('posts')
                .select(`
                    *,
                    profiles:user_id (username),
                    categories:category_id (name)
                `)
                .order('created_at', { ascending: false });

            const tableBody = document.getElementById('post-table-body');
            if (error) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger py-3">帖子加载失败</td></tr>';
                console.error('加载帖子错误:', error);
                return;
            }

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-3">暂无帖子</td></tr>';
                return;
            }

            // 渲染帖子表格
            tableBody.innerHTML = data.map(post => `
                <tr>
                    <td>${post.id}</td>
                    <td>${post.title}</td>
                    <td>${post.profiles?.username || '匿名用户'}</td>
                    <td>${post.categories?.name || '未分类'}</td>
                    <td>${formatTime(post.created_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePost(${post.id})">
                            <<i class="bi bi-trash"></</i> 删除
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 4. 加载用户列表
        async function loadUsers() {
            const { data: users, error } = await supabase
                .from('profiles')
                .select('*')
                .order('created_at', { ascending: false });

            const tableBody = document.getElementById('user-table-body');
            if (error) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger py-3">用户加载失败</td></tr>';
                console.error('加载用户错误:', error);
                return;
            }

            if (users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-3">暂无用户</td></tr>';
                return;
            }

            // 渲染用户表格（统计每个用户的帖子数）
            const userHtml = [];
            for (const user of users) {
                const { count } = await supabase
                    .from('posts')
                    .select('id', { count: 'exact' })
                    .eq('user_id', user.id);

                userHtml.push(`
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${formatTime(user.created_at)}</td>
                        <td>${count || 0}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-secondary" onclick="viewUserPosts('${user.id}')">
                                <<i class="bi bi-eye"></</i> 查看帖子
                            </button>
                        </td>
                    </tr>
                `);
            }
            tableBody.innerHTML = userHtml.join('');
        }

        // 5. 时间格式化函数
        function formatTime(isoTime) {
            const date = new Date(isoTime);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 6. 打开板块模态框（新增/编辑）
        function openCategoryModal() {
            resetCategoryForm();
            document.getElementById('categoryModalTitle').textContent = '新增板块';
            categoryModal.show();
        }

        function editCategory(id, name, sort) {
            currentCategoryId = id;
            document.getElementById('categoryId').value = id;
            document.getElementById('categoryName').value = name;
            document.getElementById('categorySort').value = sort;
            document.getElementById('categoryModalTitle').textContent = '编辑板块';
            categoryModal.show();
        }

        // 7. 保存板块（新增/编辑）
        async function saveCategory() {
            const name = document.getElementById('categoryName').value.trim();
            const sort = parseInt(document.getElementById('categorySort').value) || 0;
            const id = document.getElementById('categoryId').value;

            if (!name) {
                alert('请输入板块名称');
                return;
            }

            let error;
            if (id) {
                // 编辑板块
                ({ error } = await supabase
                    .from('categories')
                    .update({ name, sort })
                    .eq('id', id));
            } else {
                // 新增板块
                ({ error } = await supabase
                    .from('categories')
                    .insert({ name, sort, post_count: 0 }));
            }

            if (error) {
                alert('保存失败：' + error.message);
                console.error('保存板块错误:', error);
                return;
            }

            categoryModal.hide();
            await loadCategories();
            alert(id ? '编辑成功' : '新增成功');
        }

        // 8. 删除板块
        async function deleteCategory(id) {
            if (!confirm('确定要删除这个板块吗？删除后相关帖子会变成未分类')) {
                return;
            }

            const { error } = await supabase
                .from('categories')
                .delete()
                .eq('id', id);

            if (error) {
                alert('删除失败：' + error.message);
                console.error('删除板块错误:', error);
                return;
            }

            await loadCategories();
            alert('删除成功');
        }

        // 9. 删除帖子
        async function deletePost(id) {
            if (!confirm('确定要删除这篇帖子吗？')) {
                return;
            }

            const { error } = await supabase
                .from('posts')
                .delete()
                .eq('id', id);

            if (error) {
                alert('删除失败：' + error.message);
                console.error('删除帖子错误:', error);
                return;
            }

            await loadPosts();
            alert('删除成功');
        }

        // 10. 查看用户帖子
        function viewUserPosts(userId) {
            alert(`将跳转到用户 ${userId} 的帖子列表（可自行扩展页面跳转逻辑）`);
            // 可扩展：跳转到专门的用户帖子列表页，或在当前页筛选该用户的帖子
        }

        // 11. 退出登录
        async function logout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                alert('退出失败：' + error.message);
                return;
            }
            window.location.href = 'index.html';
        }

        // 12. 重置板块表单
        function resetCategoryForm() {
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryId').value = '';
            currentCategoryId = null;
        }
    </script>
</body>
</html>
