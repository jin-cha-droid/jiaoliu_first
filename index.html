<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交流论坛 - 全新完整版</title>
    <!-- 引入Bootstrap样式+图标 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { min-height: 100vh; display: flex; flex-direction: column; background-color: #f8f9fa; }
        .main-content { flex: 1; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card { border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
        .badge-top { background-color: #dc3545; }
        .badge-good { background-color: #ffc107; color: #000; }
        .category-item { cursor: pointer; padding: 8px 16px; border-radius: 20px; transition: all 0.2s; }
        .category-item.active { background-color: #0d6efd; color: #fff; }
        .category-item:hover { background-color: #e9ecef; }
        .loading { text-align: center; padding: 40px 0; color: #6c757d; }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-chat-dots-fill me-2"></i>交流论坛
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html" id="nav-all">全部帖子</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index.html" id="nav-recommend">推荐（置顶+加精）</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center" id="user-nav">
                    <!-- 未登录显示 -->
                    <button class="btn btn-sm btn-light me-2" id="btn-login" data-bs-toggle="modal" data-bs-target="#authModal">
                        登录
                    </button>
                    <button class="btn btn-sm btn-outline-light" id="btn-register" data-bs-toggle="modal" data-bs-target="#authModal">
                        注册
                    </button>
                    <!-- 已登录显示（下拉菜单） -->
                    <div class="dropdown d-none" id="user-dropdown">
                        <button class="btn btn-sm btn-light dropdown-toggle d-flex align-items-center" type="button" data-bs-toggle="dropdown">
                            <img src="" alt="头像" id="user-avatar" class="rounded-circle me-2" style="width: 24px; height: 24px; object-fit: cover;">
                            <span id="user-name">昵称</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person-fill me-2"></i>我的资料</a></li>
                            <li><a class="dropdown-item" href="admin.html" id="admin-link" class="d-none"><i class="bi bi-shield-fill me-2"></i>管理后台</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>退出登录</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <main class="main-content container py-4">
        <!-- 板块筛选栏 -->
        <div class="mb-4 p-3 bg-white rounded shadow-sm">
            <h6 class="mb-3"><i class="bi bi-grid-1x2-fill me-2"></i>论坛板块</h6>
            <div class="d-flex flex-wrap gap-2" id="category-list">
                <div class="loading">加载板块中...</div>
            </div>
        </div>

        <!-- 发帖区域（仅登录可见） -->
        <div class="card mb-4 d-none" id="post-form-card">
            <div class="card-header bg-light d-flex align-items-center">
                <i class="bi bi-pencil-square me-2"></i>
                <h6 class="mb-0">发布新帖子</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label small">选择板块 <span class="text-danger">*</span></label>
                    <select class="form-select form-select-sm" id="post-category">
                        <!-- 板块由JS动态加载 -->
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label small">帖子标题 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control form-control-sm" id="post-title" placeholder="请输入帖子标题（最多50字）" maxlength="50">
                </div>
                <div class="mb-3">
                    <label class="form-label small">帖子内容 <span class="text-danger">*</span></label>
                    <div id="post-editor">
                        <!-- 富文本编辑器由JS初始化 -->
                    </div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="publishPost()"><i class="bi bi-send me-2"></i>发布帖子</button>
            </div>
        </div>

        <!-- 帖子列表 -->
        <h6 class="mb-3 d-flex align-items-center">
            <i class="bi bi-list-ul me-2"></i>
            <span id="post-list-title">最新帖子</span>
            <span class="badge bg-secondary ms-2" id="post-count">0</span>
        </h6>
        <div id="post-list" class="gap-3 d-flex flex-column">
            <div class="loading">加载帖子中...</div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-3">
        <div class="container text-center text-sm">
            <p class="mb-0">© 2026 我的独立论坛 | 基于Supabase + GitHub Pages搭建 | 完全免费 · 独立无依赖</p>
        </div>
    </footer>

    <!-- 登录/注册弹窗 -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="authModalTitle">登录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small">邮箱 <span class="text-danger">*</span></label>
                        <input type="email" class="form-control form-control-sm" id="auth-email" placeholder="请输入你的邮箱">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small">密码 <span class="text-danger">*</span></label>
                        <input type="password" class="form-control form-control-sm" id="auth-pw" placeholder="请输入密码（至少6位）">
                    </div>
                    <div class="form-text text-sm text-muted">注册后需查收邮箱验证链接</div>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <div>
                        <span class="text-sm">还没账号？</span>
                        <a href="javascript:;" id="switch-auth" class="text-primary">立即注册</a>
                    </div>
                    <button type="button" class="btn btn-sm btn-primary" id="auth-submit" onclick="handleAuth()">登录</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入核心JS文件 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <!-- 富文本编辑器TinyMCE（免费版） -->
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

    <script>
        // ========== 替换为你自己的Supabase信息 ==========
        const SUPABASE_URL = "https://qnensenwgnopttgaepux.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_UB0PqlIa7ylybuvUqoWa1A_73oOWegR";
        // ===============================================

        // 初始化Supabase客户端
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // 全局变量
        let currentUser = null; // 当前登录用户
        let isAdmin = false; // 是否为管理员
        let currentCategoryId = null; // 当前选中板块ID
        let currentPostFilter = 'all'; // 帖子筛选：all-全部，recommend-推荐
        let categories = []; // 板块列表

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async () => {
            await initApp();
            // 绑定筛选事件
            document.getElementById('nav-all').addEventListener('click', () => switchPostFilter('all'));
            document.getElementById('nav-recommend').addEventListener('click', () => switchPostFilter('recommend'));
            // 绑定登录/注册切换事件
            document.getElementById('switch-auth').addEventListener('click', switchAuthMode);
        });

        // 初始化应用：获取用户、加载板块、加载帖子
        async function initApp() {
            // 1. 获取当前登录用户
            const { data: { user } } = await supabase.auth.getUser();
            currentUser = user;
            if (currentUser) {
                // 已登录：更新用户信息、检查管理员身份、显示发帖框
                await updateUserInfo();
                await checkAdminRole();
                document.getElementById('user-nav').querySelectorAll('button').forEach(btn => btn.classList.add('d-none'));
                document.getElementById('user-dropdown').classList.remove('d-none');
                document.getElementById('post-form-card').classList.remove('d-none');
                // 初始化富文本编辑器
                initTinyMCE('post-editor', 'post');
            } else {
                // 未登录：显示发帖提示
                document.getElementById('post-editor').innerHTML = '<div class="alert alert-info p-3 text-center">登录后可使用富文本编辑器发帖（支持图片、排版）</div>';
            }

            // 2. 加载板块列表
            await loadCategories();
            // 3. 加载帖子列表
            await loadPosts();
        }

        // 加载板块列表
        async function loadCategories() {
            const { data, error } = await supabase
                .from('categories')
                .select('*')
                .order('sort', { ascending: true });

            if (error) {
                document.getElementById('category-list').innerHTML = '<div class="text-danger">板块加载失败，请刷新页面</div>';
                console.error('加载板块失败：', error);
                return;
            }

            categories = data;
            // 渲染板块筛选栏
            let categoryHtml = '<div class="category-item active" onclick="selectCategory(null)">全部板块</div>';
            // 渲染发帖板块选择框
            let categorySelectHtml = '';
            data.forEach(cate => {
                categoryHtml += `<div class="category-item" onclick="selectCategory(${cate.id})">${cate.name}</div>`;
                categorySelectHtml += `<option value="${cate.id}">${cate.name}</option>`;
            });
            document.getElementById('category-list').innerHTML = categoryHtml;
            document.getElementById('post-category').innerHTML = categorySelectHtml;
        }

        // 选择板块
        function selectCategory(cateId) {
            currentCategoryId = cateId;
            // 更新板块选中样式
            document.getElementById('category-list').querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('active');
                if ((cateId === null && item.innerText === '全部板块') || (item.onclick && item.onclick.toString().includes(cateId))) {
                    item.classList.add('active');
                }
            });
            // 重新加载帖子
            loadPosts();
            // 更新帖子列表标题
            const cateName = cateId ? categories.find(c => c.id === cateId).name : '全部板块';
            document.getElementById('post-list-title').innerText = currentPostFilter === 'recommend' ? `【推荐】${cateName}` : cateName;
        }

        // 切换帖子筛选条件
        function switchPostFilter(filter) {
            currentPostFilter = filter;
            // 更新导航选中样式
            document.getElementById('nav-all').classList.toggle('active', filter === 'all');
            document.getElementById('nav-recommend').classList.toggle('active', filter === 'recommend');
            // 重新加载帖子
            loadPosts();
            // 更新帖子列表标题
            const cateName = currentCategoryId ? categories.find(c => c.id === currentCategoryId).name : '全部板块';
            document.getElementById('post-list-title').innerText = filter === 'recommend' ? `【推荐】${cateName}` : cateName;
        }

        // 加载帖子列表
        async function loadPosts() {
            document.getElementById('post-list').innerHTML = '<div class="loading"><i class="bi bi-hourglass-split me-2"></i>加载中...</div>';
            // 构建查询
            let query = supabase
                .from('posts')
                .select(`
                    id, title, content, is_top, is_good, created_at,
                    profiles(id, username, avatar_url),
                    categories(name)
                `)
                .order('is_top', { ascending: false }) // 置顶优先
                .order('created_at', { ascending: false });

            // 筛选板块
            if (currentCategoryId) {
                query = query.eq('category_id', currentCategoryId);
            }
            // 筛选推荐（置顶+加精）
            if (currentPostFilter === 'recommend') {
                query = query.or('is_top.eq.true, is_good.eq.true');
            }

            // 执行查询并统计数量
            const { data, error, count } = await query.count('exact');
            document.getElementById('post-count').innerText = count || 0;

            if (error) {
                document.getElementById('post-list').innerHTML = '<div class="alert alert-danger text-center p-3">帖子加载失败</div>';
                console.error('加载帖子失败：', error);
                return;
            }

            if (!data || data.length === 0) {
                document.getElementById('post-list').innerHTML = '<div class="alert alert-light text-center p-3">暂无帖子，快来发布第一个帖子吧！</div>';
                return;
            }

            // 渲染帖子列表
            let postHtml = '';
            data.forEach(post => {
                // 截取内容摘要（去除HTML标签）
                const contentText = post.content.replace(/<[^>]+>/g, '').substring(0, 100) + '...';
                // 置顶/加精标签
                const tags = [];
                if (post.is_top) tags.push('<span class="badge badge-top badge-sm me-1">置顶</span>');
                if (post.is_good) tags.push('<span class="badge badge-good badge-sm me-1">加精</span>');
                // 头像处理
                const avatar = post.profiles.avatar_url || 'https://picsum.photos/200/200';

                postHtml += `
                    <div class="card">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="d-flex align-items-center">
                                    <img src="${avatar}" alt="${post.profiles.username}" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
                                    <span class="fw-medium">${post.profiles.username}</span>
                                    <span class="text-muted small ms-2">${post.categories?.name || '未分类'}</span>
                                </div>
                                <span class="text-muted small">${formatTime(post.created_at)}</span>
                            </div>
                            <h5 class="card-title h6 mb-2">
                                ${tags.join('')}
                                <a href="post.html?id=${post.id}" class="text-dark text-decoration-none">${post.title}</a>
                            </h5>
                            <p class="card-text text-muted small mb-3">${contentText}</p>
                            <a href="post.html?id=${post.id}" class="btn btn-sm btn-outline-primary">查看详情 <i class="bi bi-chevron-right"></i></a>
                        </div>
                    </div>
                `;
            });
            document.getElementById('post-list').innerHTML = postHtml;
        }

        // 发布帖子
        async function publishPost() {
            const title = document.getElementById('post-title').value.trim();
            const categoryId = document.getElementById('post-category').value;
            const content = tinymce.get('post-editor').getContent().trim();

            // 表单验证
            if (!title) {
                alert('请输入帖子标题！');
                return;
            }
            if (title.length > 50) {
                alert('帖子标题不能超过50字！');
                return;
            }
            if (!content) {
                alert('请输入帖子内容！');
                return;
            }

            // 提交到数据库
            const { error } = await supabase
                .from('posts')
                .insert([{
                    title,
                    content,
                    user_id: currentUser.id,
                    category_id: categoryId
                }]);

            if (error) {
                alert('帖子发布失败：' + error.message);
                console.error('发布帖子失败：', error);
                return;
            }

            // 发布成功：清空表单、重新加载帖子
            document.getElementById('post-title').value = '';
            tinymce.get('post-editor').setContent('');
            alert('帖子发布成功！');
            loadPosts();
        }

        // 初始化富文本编辑器（帖子/评论通用）
        function initTinyMCE(editorId, type) {
            tinymce.init({
                selector: `#${editorId}`,
                height: type === 'post' ? 300 : 150,
                menubar: false,
                plugins: 'advlist autolink lists link image charmap preview removeformat help',
                toolbar: 'undo redo | bold italic | alignleft aligncenter | bullist numlist | image | removeformat | help',
                // 图片上传配置（对接Supabase存储）
                images_upload_handler: async (blobInfo, progress) => {
                    return new Promise(async (resolve, reject) => {
                        const fileName = `${currentUser.id}/${Date.now()}-${blobInfo.filename()}`;
                        const blob = await blobInfo.blob();

                        // 上传图片到Supabase
                        const { data, error } = await supabase
                            .storage
                            .from('forum-assets')
                            .upload(fileName, blob, {
                                cacheControl: '3600',
                                upsert: false,
                                contentType: blob.type
                            });

                        if (error) {
                            reject('图片上传失败：' + error.message);
                            return;
                        }

                        // 获取图片公共链接
                        const { data: { publicUrl } } = supabase
                            .storage
                            .from('forum-assets')
                            .getPublicUrl(data.path);

                        resolve(publicUrl);
                    });
                },
                branding: false, // 隐藏TinyMCE标识
                resize: false,
                placeholder: type === 'post' ? '请输入帖子内容，支持图片、文字排版...' : '请输入评论内容...'
            });
        }

        // 处理登录/注册
        async function handleAuth() {
            const email = document.getElementById('auth-email').value.trim();
            const pw = document.getElementById('auth-pw').value.trim();
            const isRegister = document.getElementById('authModalTitle').innerText === '注册';

            // 验证输入
            if (!email || !pw) {
                alert('请填写邮箱和密码！');
                return;
            }
            if (pw.length < 6) {
                alert('密码至少6位！');
                return;
            }

            let { error } = {};
            if (isRegister) {
                // 注册：发送验证邮件
                ({ error } = await supabase.auth.signUp({ email, password: pw }));
                if (!error) {
                    alert('注册成功！请查收邮箱中的验证链接，验证后即可登录！');
                    switchAuthMode(); // 切回登录模式
                }
            } else {
                // 登录
                ({ error } = await supabase.auth.signInWithPassword({ email, password: pw }));
                if (!error) {
                    bootstrap.Modal.getInstance(document.getElementById('authModal')).hide(); // 关闭弹窗
                    await initApp(); // 重新初始化应用
                }
            }

            if (error) {
                alert((isRegister ? '注册' : '登录') + '失败：' + error.message);
                console.error(error);
            }
        }

        // 切换登录/注册模式
        function switchAuthMode() {
            const title = document.getElementById('authModalTitle');
            const submitBtn = document.getElementById('auth-submit');
            const switchText = document.getElementById('switch-auth');
            const isRegister = title.innerText === '注册';

            if (isRegister) {
                title.innerText = '登录';
                submitBtn.innerText = '登录';
                switchText.innerText = '立即注册';
            } else {
                title.innerText = '注册';
                submitBtn.innerText = '注册';
                switchText.innerText = '返回登录';
            }
        }

        // 退出登录
        async function logout() {
            const { error } = await supabase.auth.signOut();
            if (!error) {
                window.location.reload(); // 刷新页面
            } else {
                alert('退出失败：' + error.message);
            }
        }

        // 更新用户信息（头像、昵称）
        async function updateUserInfo() {
            const { data, error } = await supabase
                .from('profiles')
                .select('username, avatar_url')
                .eq('id', currentUser.id)
                .single();

            if (!error && data) {
                document.getElementById('user-name').innerText = data.username;
                document.getElementById('user-avatar').src = data.avatar_url || 'https://picsum.photos/200/200';
            }
        }

        // 检查是否为管理员
        async function checkAdminRole() {
            const { data, error } = await supabase
                .from('admins')
                .select('*')
                .eq('user_id', currentUser.id)
                .single();

            isAdmin = !error && data;
            if (isAdmin) {
                document.getElementById('admin-link').classList.remove('d-none');
            }
        }

        // 格式化时间：YYYY-MM-DD HH:mm
        function formatTime(timeStr) {
            const date = new Date(timeStr);
            return date.getFullYear() + '-' +
                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                String(date.getDate()).padStart(2, '0') + ' ' +
                String(date.getHours()).padStart(2, '0') + ':' +
                String(date.getMinutes()).padStart(2, '0');
        }
    </script>
</body>
</html>
